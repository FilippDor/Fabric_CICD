<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Power BI Visual Testing Dashboard</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2128;
    --border: #30363d;
    --text: #c9d1d9;
    --text-muted: #8b949e;
    --text-bright: #f0f6fc;
    --green: #3fb950;
    --green-bg: rgba(63,185,80,0.15);
    --red: #f85149;
    --red-bg: rgba(248,81,73,0.15);
    --blue: #58a6ff;
    --blue-bg: rgba(88,166,255,0.15);
    --yellow: #d29922;
    --yellow-bg: rgba(210,153,34,0.15);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.5; }

  /* ---- NAV ---- */
  .nav { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .nav h1 { font-size: 18px; color: var(--text-bright); font-weight: 700; display: flex; align-items: center; gap: 10px; }
  .nav .links { display: flex; gap: 20px; }
  .nav .links a { color: var(--blue); text-decoration: none; font-size: 14px; }
  .nav .links a:hover { text-decoration: underline; }

  /* ---- MAIN CONTENT ---- */
  .container { max-width: 1100px; margin: 0 auto; padding: 40px 24px; }

  /* ---- SUMMARY CARDS ---- */
  .summary-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 16px; margin-bottom: 40px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; }
  .stat-card .val { font-size: 36px; font-weight: 700; color: var(--text-bright); }
  .stat-card .val.green { color: var(--green); }
  .stat-card .val.red { color: var(--red); }
  .stat-card .val.blue { color: var(--blue); }
  .stat-card .val.yellow { color: var(--yellow); }
  .stat-card .lbl { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 6px; }

  /* ---- SECTION ---- */
  .section-title { font-size: 20px; font-weight: 700; color: var(--text-bright); margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }

  /* ---- REPORT TABLE ---- */
  .report-table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
  .report-table th { text-align: left; padding: 12px 16px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid var(--border); }
  .report-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
  .report-table tr:hover { background: rgba(255,255,255,.02); }
  .badge { display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; }
  .badge.pass { background: var(--green-bg); color: var(--green); }
  .badge.fail { background: var(--red-bg); color: var(--red); }

  /* ---- FAILED PAGES ---- */
  .failed-card { background: var(--surface); border: 1px solid var(--border); border-left: 4px solid var(--red); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
  .failed-card h3 { color: var(--text-bright); font-size: 16px; margin-bottom: 8px; }
  .failed-card .meta { color: var(--text-muted); font-size: 13px; margin-bottom: 12px; }
  .failed-card .meta a { color: var(--blue); text-decoration: none; }
  .failed-card .meta a:hover { text-decoration: underline; }
  .error-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 12px; }
  .error-table th { text-align: left; padding: 8px 12px; background: var(--bg); color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
  .error-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); color: var(--red); }
  .screenshot { max-width: 100%; border-radius: 8px; border: 1px solid var(--border); margin-top: 12px; }

  /* ---- FOOTER ---- */
  .footer { text-align: center; padding: 32px 24px; border-top: 1px solid var(--border); color: var(--text-muted); font-size: 13px; }
  .footer a { color: var(--blue); text-decoration: none; }

  /* ---- RESPONSIVE ---- */
  @media (max-width: 768px) {
    .summary-grid { grid-template-columns: repeat(2,1fr); }
  }
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <h1>
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    Power BI Visual Testing
  </h1>
  <div class="links">
    <a href="#results">Results</a>
    <a href="#failures">Failures</a>
    <a href="https://github.com/FilippDor/Fabric-UI-testing" target="_blank">GitHub</a>
  </div>
</nav>

<!-- MAIN CONTENT -->
<div class="container">

  <!-- Summary Stats (populated by JS) -->
  <div id="summary-grid" class="summary-grid"></div>

  <!-- Report Results Table -->
  <h2 class="section-title" id="results">Report Results</h2>
  <table class="report-table">
    <thead><tr><th>Report</th><th>Pages</th><th>Passed</th><th>Failed</th><th>Duration</th><th>Status</th></tr></thead>
    <tbody id="report-rows"></tbody>
  </table>

  <!-- Failed Pages -->
  <h2 class="section-title" id="failures">Failed Pages</h2>
  <div id="failed-pages"></div>


</div>

<!-- FOOTER -->
<div class="footer">
  <p>Generated by <a href="https://github.com/FilippDor/Fabric-UI-testing">Power BI Visual Testing Pipeline</a> &mdash; <span id="generated-at"></span></p>
  <p style="margin-top:4px;">Python + Pytest + Playwright + GitHub Actions</p>
</div>

<!-- DATA-DRIVEN RENDERING -->
<script>
(async () => {
  let data;
  try {
    const resp = await fetch('all_reports_results.json');
    data = await resp.json();
  } catch (e) {
    document.getElementById('summary-grid').innerHTML = '<p style="color:var(--red);grid-column:1/-1;">Failed to load results JSON.</p>';
    return;
  }

  const summary = data.summary;
  const reports = data.reports;

  // Generated at
  document.getElementById('generated-at').textContent = data.generatedAt || 'N/A';

  // Summary cards
  document.getElementById('summary-grid').innerHTML = `
    <div class="stat-card"><div class="val blue">${summary.totalReports}</div><div class="lbl">Reports</div></div>
    <div class="stat-card"><div class="val">${summary.totalPages}</div><div class="lbl">Total Pages</div></div>
    <div class="stat-card"><div class="val green">${summary.passedPages}</div><div class="lbl">Passed</div></div>
    <div class="stat-card"><div class="val red">${summary.failedPages}</div><div class="lbl">Failed</div></div>
    <div class="stat-card"><div class="val yellow">${summary.passRate}%</div><div class="lbl">Pass Rate</div></div>
  `;

  // Report table
  const tbody = document.getElementById('report-rows');
  reports.forEach(r => {
    const pages = Object.values(r.pages || {});
    const total = pages.length;
    const failed = pages.filter(p => p.errors && Object.keys(p.errors).length > 0).length;
    const passed = total - failed;
    const dur = (r.totalDuration / 1000).toFixed(1);
    const status = failed > 0
      ? `<span class="badge fail">${failed} FAIL</span>`
      : `<span class="badge pass">PASS</span>`;
    tbody.innerHTML += `<tr>
      <td style="color:var(--text-bright);font-weight:600;">${r.reportName}</td>
      <td>${total}</td>
      <td style="color:var(--green)">${passed}</td>
      <td style="color:${failed > 0 ? 'var(--red)' : 'var(--text-muted)'}">${failed}</td>
      <td style="color:var(--text-muted)">${dur}s</td>
      <td>${status}</td>
    </tr>`;
  });

  // Failed pages
  const failedContainer = document.getElementById('failed-pages');
  let hasFailures = false;

  reports.forEach(r => {
    Object.entries(r.pages || {}).forEach(([pageName, info]) => {
      if (!info.errors || Object.keys(info.errors).length === 0) return;
      hasFailures = true;

      const errorRows = Object.entries(info.errors)
        .map(([vid, msg]) => `<tr><td style="color:var(--text-muted)">${vid}</td><td>${msg}</td></tr>`)
        .join('');

      // Try to find screenshot (check common suffixes)
      const screenshotCandidates = ['master', 'gw0', 'gw1', 'gw2', 'gw3'];
      let screenshotHtml = '';
      const imgEl = document.createElement('img');

      failedContainer.innerHTML += `
        <div class="failed-card">
          <h3>${r.reportName} &mdash; ${pageName}</h3>
          <div class="meta">
            Duration: ${(info.duration / 1000).toFixed(1)}s &nbsp;|&nbsp;
            <a href="${info.serviceUrl}" target="_blank">Open in Power BI</a>
          </div>
          <table class="error-table">
            <thead><tr><th>Visual</th><th>Error</th></tr></thead>
            <tbody>${errorRows}</tbody>
          </table>
          <div class="screenshot-container" data-page="${pageName}"></div>
        </div>
      `;
    });
  });

  if (!hasFailures) {
    failedContainer.innerHTML = `
      <div style="text-align:center;padding:40px;background:var(--surface);border-radius:12px;border:1px solid var(--border);">
        <div style="font-size:48px;margin-bottom:12px;">&#9989;</div>
        <h3 style="color:var(--green);font-size:18px;">All pages passed visual validation</h3>
      </div>
    `;
  }

  // Load screenshots
  document.querySelectorAll('.screenshot-container').forEach(container => {
    const pageName = container.dataset.page;
    const suffixes = ['master', 'gw0', 'gw1', 'gw2', 'gw3'];
    for (const suffix of suffixes) {
      const img = new Image();
      const src = `${pageName}_${suffix}.png`;
      img.onload = () => {
        img.className = 'screenshot';
        img.alt = pageName;
        container.appendChild(img);
      };
      img.src = src;
    }
  });
})();
</script>

</body>
</html>
